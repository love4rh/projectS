<?xml version="1.0" encoding="UTF-8"?>

<crawlegoProject version="1.0">
	<settings>
		<params>
		</params>
	</settings>

	<macros>
		<macro name="BASIS_DAY" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[20130829]]></param>
		</macro>
		<macro name="IN_PATH" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[D:\work\jupyter\krx\output\logicResult\4PXX-25-10T-10-M2\]]></param>
		</macro>
		<macro name="OUT_PATH" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[D:\work\jupyter\krx\intermediate\analMM\]]></param>
		</macro>
		<macro name="DO_SERVER" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[13.124.29.70]]></param>
		</macro>
		<macro name="START_DATE" class="com.lge.crawlego.macro.ExpressionValue">
			<param name="expression"><![CDATA[DATETOSTR(STRTODATE('$(BASIS_DAY)', 'yyyyMMdd') - 180, 'yyyyMMdd')]]></param>
		</macro>
		<macro name="END_DATE" class="com.lge.crawlego.macro.ExpressionValue">
			<param name="expression"><![CDATA[DATETOSTR(STRTODATE('$(BASIS_DAY)', 'yyyyMMdd') + 180, 'yyyyMMdd')]]></param>
		</macro>
		<macro name="P_YEAR" class="com.lge.crawlego.macro.ExpressionValue">
			<param name="expression"><![CDATA[SUBSTR('$(START_DATE)', 1, 4)]]></param>
		</macro>
		<macro name="N_YEAR" class="com.lge.crawlego.macro.ExpressionValue">
			<param name="expression"><![CDATA[IIF('$(P_YEAR)' = SUBSTR('$(END_DATE)', 1, 4), '2012', SUBSTR('$(END_DATE)', 1, 4))]]></param>
		</macro>
	</macros>



	<inputNodes>
		<inputNode name="ITEMS" type="FILE">
			<path><![CDATA[$(IN_PATH)$(BASIS_DAY)-RESULT.txt]]></path>
			<columns>
				<column name="P_CODE" type="string" />
				<column name="종목명" type="string" />
				<column name="자산총계" type="real" />
				<column name="시가총액_억" type="real" />
				<column name="매수일" type="string" />
				<column name="매수가" type="real" />
				<column name="매도일" type="string" />
				<column name="매도가" type="real" />
				<column name="거래량" type="real" />
				<column name="매수량" type="real" />
				<column name="RISK" type="real" />
				<column name="REVENUE" type="real" />
			</columns>
			<ui>
				<position x="69" y="94" />
				<description><![CDATA[]]></description>
			</ui>
		</inputNode>

		<inputNode name="S_PRICE" type="dataOn">
			<query><![CDATA[SELECT 종목코드 "P_CODE", 종목명, 날짜, 시가, 고가, 저가, 종가
  FROM PRICE.Y$(P_YEAR)
 WHERE '$(START_DATE)' <= 날짜 AND 날짜 <= '$(END_DATE)']]></query>
			<params>
				<param name="collection"><![CDATA[PRICE]]></param>
				<param name="password"><![CDATA[1234]]></param>
				<param name="port"><![CDATA[6362]]></param>
				<param name="server"><![CDATA[$(DO_SERVER)]]></param>
				<param name="user"><![CDATA[admin]]></param>
			</params>
			<columns>
				<column name="P_CODE" type="string" />
				<column name="종목명" type="string" />
				<column name="날짜" type="string" />
				<column name="시가" type="real" />
				<column name="고가" type="real" />
				<column name="저가" type="real" />
				<column name="종가" type="real" />
			</columns>
			<ui>
				<position x="69" y="235" />
				<description><![CDATA[]]></description>
			</ui>
		</inputNode>

		<inputNode name="N_PRICE" type="dataOn">
			<query><![CDATA[SELECT 종목코드 "P_CODE", 종목명, 날짜, 시가, 고가, 저가, 종가
  FROM PRICE.Y$(N_YEAR)
 WHERE '$(START_DATE)' <= 날짜 AND 날짜 <= '$(END_DATE)']]></query>
			<params>
				<param name="collection"><![CDATA[PRICE]]></param>
				<param name="password"><![CDATA[1234]]></param>
				<param name="port"><![CDATA[6362]]></param>
				<param name="server"><![CDATA[$(DO_SERVER)]]></param>
				<param name="user"><![CDATA[admin]]></param>
			</params>
			<columns>
				<column name="P_CODE" type="string" />
				<column name="종목명" type="string" />
				<column name="날짜" type="string" />
				<column name="시가" type="real" />
				<column name="고가" type="real" />
				<column name="저가" type="real" />
				<column name="종가" type="real" />
			</columns>
			<ui>
				<position x="235" y="375" />
				<description><![CDATA[]]></description>
			</ui>
		</inputNode>
	</inputNodes>


	<dataProcessing>
		<processingElem type="merge">
			<dataSources>
				<dataSource alias="A1"><![CDATA[ITEMS]]></dataSource>
				<dataSource alias="A2"><![CDATA[SN_PRICE]]></dataSource>
			</dataSources>
			<dataGroupName><![CDATA[SELECT_PCODE]]></dataGroupName>
			<ui>
				<position x="235" y="93" />
				<description><![CDATA[]]></description>
			</ui>
			<joinMethod>inner</joinMethod>
			<addKeyColumn>false</addKeyColumn>
			<equalKeys>
				<equalKey source="ITEMS"><![CDATA[P_CODE]]></equalKey>
				<equalKey source="SN_PRICE"><![CDATA[P_CODE]]></equalKey>
			</equalKeys>
			<selectColumns>
				<columns source="ITEMS"><![CDATA[P_CODE,종목명,매수일,매수가,매수량]]></columns>
				<columns source="SN_PRICE"><![CDATA[날짜,시가,종가]]></columns>
			</selectColumns>
		</processingElem>

		<processingElem type="sort">
			<dataSource alias="A1"><![CDATA[SELECT_PCODE]]></dataSource>
			<dataGroupName><![CDATA[SORTBYBASE]]></dataGroupName>
			<ui>
				<position x="401" y="93" />
				<description><![CDATA[]]></description>
			</ui>
			<sortColumns>
				<column order="ascending">P_CODE</column>
				<column order="ascending">날짜</column>
			</sortColumns>
		</processingElem>

		<processingElem type="append">
			<dataSources>
				<dataSource alias="A1"><![CDATA[S_PRICE]]></dataSource>
				<dataSource alias="A2"><![CDATA[N_PRICE]]></dataSource>
			</dataSources>
			<dataGroupName><![CDATA[SN_PRICE]]></dataGroupName>
			<ui>
				<position x="235" y="235" />
				<description><![CDATA[]]></description>
			</ui>
			<appendMethod>first</appendMethod>
		</processingElem>

		<processingElem type="pivot">
			<dataSource alias="A1"><![CDATA[SORTBYBASE]]></dataSource>
			<dataGroupName><![CDATA[PIVOT_PRICE]]></dataGroupName>
			<ui>
				<position x="401" y="251" />
				<description><![CDATA[]]></description>
			</ui>
			<columnColumns><![CDATA[P_CODE]]></columnColumns>
			<namePrefix><![CDATA[P_]]></namePrefix>
			<rowColumns><![CDATA[날짜]]></rowColumns>
			<valueColumns><![CDATA[종가, 매수량]]></valueColumns>
			<recalculateRuntime><![CDATA[true]]></recalculateRuntime>
			<remake>true for regenerate columns</remake>
			<!-- DO NOT EDIT BELOW -->
			<columns>
				<column name="날짜" type="string" />
				<column name="P_001810_종가" type="real" />
				<column name="P_004090_종가" type="real" />
				<column name="P_010960_종가" type="real" />
				<column name="P_012620_종가" type="real" />
				<column name="P_017370_종가" type="real" />
				<column name="P_017650_종가" type="real" />
				<column name="P_025550_종가" type="real" />
				<column name="P_026940_종가" type="real" />
				<column name="P_053260_종가" type="real" />
				<column name="P_093240_종가" type="real" />
				<column name="P_001810_매수량" type="real" />
				<column name="P_004090_매수량" type="real" />
				<column name="P_010960_매수량" type="real" />
				<column name="P_012620_매수량" type="real" />
				<column name="P_017370_매수량" type="real" />
				<column name="P_017650_매수량" type="real" />
				<column name="P_025550_매수량" type="real" />
				<column name="P_026940_매수량" type="real" />
				<column name="P_053260_매수량" type="real" />
				<column name="P_093240_매수량" type="real" />
			</columns>
		</processingElem>

		<processingElem type="derived">
			<dataSource alias="A1"><![CDATA[PIVOT_PRICE]]></dataSource>
			<dataGroupName><![CDATA[CALC_INDEX]]></dataGroupName>
			<ui>
				<position x="528" y="251" />
				<description><![CDATA[]]></description>
			</ui>
			<addColumns>
				<derivedColumn name="IDX"><![CDATA[@ROWNUM]]></derivedColumn>
				<derivedColumn name="IDX10"><![CDATA[@ROWNUM / 100]]></derivedColumn>
				<derivedColumn name="BUY_AMOUNT"><![CDATA[ROWSUM(12, 21)]]></derivedColumn>
				<derivedColumn name="AVG_INDEX"><![CDATA[(
GETVALUE(2) * GETVALUE(12) +
GETVALUE(3) * GETVALUE(13) +
GETVALUE(4) * GETVALUE(14) +
GETVALUE(5) * GETVALUE(15) +
GETVALUE(6) * GETVALUE(16) +
GETVALUE(7) * GETVALUE(17) +
GETVALUE(8) * GETVALUE(18) +
GETVALUE(9) * GETVALUE(19) +
GETVALUE(10) * GETVALUE(20) +
GETVALUE(11) * GETVALUE(21)
) / {BUY_AMOUNT}]]></derivedColumn>
				<derivedColumn name="RRI_180"><![CDATA[IIF(@ROWNUM = 1, 1, GETVALUE(@{AVG_INDEX}) / GETVALUE(@{AVG_INDEX}, - @ROWNUM + 1))]]></derivedColumn>
				<derivedColumn name="RRI_90"><![CDATA[IIF(@ROWNUM < 65, 0, GETVALUE(@{AVG_INDEX}) / GETVALUE(@{AVG_INDEX}, -65))]]></derivedColumn>
				<derivedColumn name="IDX_90"><![CDATA[@ROWNUM - 65]]></derivedColumn>
				<derivedColumn name="SLOPE_180"><![CDATA[IIF(@ROWNUM < @DATASIZE, 0, LINEARSLOPE(@{IDX10}, @{RRI_180}, @ROWNUM - 1) )]]></derivedColumn>
				<derivedColumn name="SLOPE_90"><![CDATA[IIF(@ROWNUM < @DATASIZE, 0, LINEARSLOPE(@{IDX10}, @{RRI_90}, @ROWNUM - 1 - 65) )]]></derivedColumn>
				<derivedColumn name="BASIS_DATE"><![CDATA['$(BASIS_DAY)']]></derivedColumn>
			</addColumns>
		</processingElem>

		<processingElem type="orderAndFilter">
			<dataSource alias="A1"><![CDATA[CALC_INDEX]]></dataSource>
			<dataGroupName><![CDATA[6M-COLUMNS]]></dataGroupName>
			<ui>
				<position x="698" y="301" />
				<description><![CDATA[]]></description>
			</ui>
			<orderAndFilter>
				<column>BASIS_DATE</column>
				<column>IDX</column>
				<column>날짜</column>
				<column toName="RRI">RRI_180</column>
			</orderAndFilter>
		</processingElem>

		<processingElem type="select">
			<dataSource alias="A1"><![CDATA[CALC_INDEX]]></dataSource>
			<dataGroupName><![CDATA[3M_VALID_ONLY]]></dataGroupName>
			<ui>
				<position x="527" y="416" />
				<description><![CDATA[]]></description>
			</ui>
			<condition><![CDATA[{IDX_90} > 0]]></condition>
		</processingElem>

		<processingElem type="orderAndFilter">
			<dataSource alias="A1"><![CDATA[3M_VALID_ONLY]]></dataSource>
			<dataGroupName><![CDATA[3M-COLUMNS]]></dataGroupName>
			<ui>
				<position x="802" y="417" />
				<description><![CDATA[]]></description>
			</ui>
			<orderAndFilter>
				<column toName="IDX">IDX_90</column>
				<column>날짜</column>
				<column toName="S_$(BASIS_DAY)_90">RRI_90</column>
			</orderAndFilter>
		</processingElem>

		<processingElem type="orderAndFilter">
			<dataSource alias="A1"><![CDATA[CALC_INDEX]]></dataSource>
			<dataGroupName><![CDATA[RESULT_SLOPE]]></dataGroupName>
			<ui>
				<position x="703" y="183" />
				<description><![CDATA[]]></description>
			</ui>
			<orderAndFilter>
				<column>날짜</column>
				<column toName="S_$(BASIS_DAY)_6M">SLOPE_180</column>
				<column toName="S_$(BASIS_DAY)_3M">SLOPE_90</column>
			</orderAndFilter>
		</processingElem>

		<processingElem type="select">
			<dataSource alias="A1"><![CDATA[RESULT_SLOPE]]></dataSource>
			<dataGroupName><![CDATA[SelectData_2]]></dataGroupName>
			<ui>
				<position x="857" y="182" />
				<description><![CDATA[]]></description>
			</ui>
			<condition><![CDATA[@ROWNUM = @DATASIZE]]></condition>
		</processingElem>
	</dataProcessing>

	<dataLoadings>
		<dataLoading name="SAVE_1" source="SelectData_2" type="file">
			<filePath><![CDATA[$(OUT_PATH)SLOPE-$(BASIS_DAY).txt]]></filePath>
			<remainFinFile><![CDATA[false]]></remainFinFile>
			<finFile><![CDATA[]]></finFile>
			<ui>
				<position x="1002" y="184" />
				<description><![CDATA[]]></description>
			</ui>
		</dataLoading>

		<dataLoading name="SAVE" source="6M-COLUMNS" type="file">
			<filePath><![CDATA[$(OUT_PATH)SA-$(BASIS_DAY).txt]]></filePath>
			<remainFinFile><![CDATA[false]]></remainFinFile>
			<finFile><![CDATA[]]></finFile>
			<ui>
				<position x="856" y="303" />
				<description><![CDATA[]]></description>
			</ui>
		</dataLoading>

	</dataLoadings>
</crawlegoProject>
