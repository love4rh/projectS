<?xml version="1.0" encoding="UTF-8"?>

<crawlegoProject version="1.0">
	<settings>
		<params>
		</params>
	</settings>

	<macros>
		<macro name="PCODE" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[010400]]></param>
		</macro>
		<macro name="START" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[20210101]]></param>
		</macro>
		<macro name="END" class="com.lge.crawlego.macro.ExpressionValue">
			<param name="expression"><![CDATA[DATETOSTR(NOW(), 'yyyyMMdd')]]></param>
		</macro>
		<macro name="ALPHA" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[0.011]]></param>
		</macro>
		<macro name="RP" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[0.05]]></param>
		</macro>
		<macro name="RL" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[0.05]]></param>
		</macro>
		<macro name="N" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[5]]></param>
		</macro>
		<macro name="B" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[2]]></param>
		</macro>
		<macro name="DATA_PATH" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[C:\Workspace\krx\intermediate\variance\data\]]></param>
		</macro>
		<macro name="OUT_PATH" class="com.lge.crawlego.macro.DefinedValue">
			<param name="value"><![CDATA[C:\Workspace\krx\intermediate\variance\result\]]></param>
		</macro>
	</macros>



	<inputNodes>
		<inputNode name="STD_BASIS" type="FILE">
			<path><![CDATA[$(DATA_PATH)totalStd-$(PCODE).txt]]></path>
			<params>
				<param name="fetchType"><![CDATA[LOCAL]]></param>
			</params>
			<columns>
				<column name="PCODE" type="string" />
				<column name="SV5MEAN" type="real" />
				<column name="SV5STD" type="real" />
			</columns>
			<ui>
				<position x="93" y="303" />
				<description><![CDATA[]]></description>
			</ui>
		</inputNode>

		<inputNode name="INDEX_DATA" type="FILE">
			<path><![CDATA[$(DATA_PATH)variance-$(PCODE).txt]]></path>
			<params>
				<param name="fetchType"><![CDATA[LOCAL]]></param>
			</params>
			<columns>
				<column name="날짜" type="string" />
				<column name="WEEKNO" type="integer" />
				<column name="SP" type="real" />
				<column name="HP" type="real" />
				<column name="LP" type="real" />
				<column name="EP" type="real" />
				<column name="TA" type="real" />
				<column name="FR" type="real" />
				<column name="PCODE" type="string" />
				<column name="MV_LOW" type="real" />
				<column name="MV_HIGH" type="real" />
				<column name="MEAN" type="real" />
				<column name="SV5_LOW" type="real" />
				<column name="SV5_AVG" type="real" />
				<column name="SV5_HIGH" type="real" />
			</columns>
			<ui>
				<position x="91" y="156" />
				<description><![CDATA[]]></description>
			</ui>
		</inputNode>
	</inputNodes>


	<dataProcessing>
		<processingElem type="derived">
			<dataSource alias="A1"><![CDATA[SRT_DATA]]></dataSource>
			<dataGroupName><![CDATA[ADD_INDEX]]></dataGroupName>
			<ui>
				<position x="329" y="375" />
				<description><![CDATA[]]></description>
			</ui>
			<addColumns>
				<derivedColumn name="BASIS"><![CDATA[{SV5STD}]]></derivedColumn>
				<derivedColumn name="IN_COUNT"><![CDATA[IIF({SV5_LOW} < {BASIS}, 2, 0)]]></derivedColumn>
				<derivedColumn name="T_BOX_IDX"><![CDATA[IIF( @ROWNUM < $(N) + 1, A := 0,
IIF( {IN_COUNT} >= 2
   , IIF( GETVALUE(@THIS, -1) > 0
        , GETVALUE(@THIS, -1)
        , IIF( MVMAX(@THIS, 2, 0) > 0, MVMAX(@THIS, 2, 0), A := A + 1 )
     )
   , 0
))]]></derivedColumn>
				<derivedColumn name="BOX_IDX"><![CDATA[IIF( @ROWNUM < $(N) + 1 OR @ROWNUM >= @DATASIZE, 0,
   IIF( {T_BOX_IDX} > 0, {T_BOX_IDX},
      IIF( {T_BOX_IDX}[-1] = {T_BOX_IDX}[1], {T_BOX_IDX}[-1], 0 )
   )
)]]></derivedColumn>
				<derivedColumn name="ELEM_IDX"><![CDATA[IIF( @ROWNUM < $(N) + 1 OR {BOX_IDX} = 0, B := 0,
   IIF( {BOX_IDX}[-1] = {BOX_IDX}, B := B + 1, B := 1 )
)]]></derivedColumn>
				<derivedColumn name="MV5-P"><![CDATA[INT((MVSUM(@{MEAN}, 10, 1) - MVSUM(@{MEAN}, 5, 1)) / 5, 0)]]></derivedColumn>
				<derivedColumn name="MV5-C"><![CDATA[INT(MVAVG(@{MEAN}, 5, 1), 0)]]></derivedColumn>
				<derivedColumn name="RATIO"><![CDATA[{MEAN} / {MV5-P}]]></derivedColumn>
				<derivedColumn name="GUESS_BP"><![CDATA[IIF( {ELEM_IDX} < $(B), 0,
   IIF( {ELEM_IDX} >= $(B) AND MVMAX(@{RATIO}, {ELEM_IDX}) <= 1.05, INT(MVAVG(@{LP}, 5, 0), 0), GETVALUE(@THIS, -1) )
)]]></derivedColumn>
			</addColumns>
		</processingElem>

		<processingElem type="orderAndFilter">
			<dataSource alias="A1"><![CDATA[ADD_INDEX]]></dataSource>
			<dataGroupName><![CDATA[ITEM_GUESS]]></dataGroupName>
			<ui>
				<position x="477" y="375" />
				<description><![CDATA[]]></description>
			</ui>
			<orderAndFilter>
				<column>PCODE</column>
				<column>날짜</column>
				<column>BOX_IDX</column>
				<column>ELEM_IDX</column>
				<column>SP</column>
				<column>EP</column>
				<column>LP</column>
				<column>HP</column>
				<column>MEAN</column>
				<column>SV5_LOW</column>
				<column>GUESS_BP</column>
				<column>RATIO</column>
			</orderAndFilter>
		</processingElem>

		<processingElem type="derived">
			<dataSource alias="A1"><![CDATA[ITEM_GUESS]]></dataSource>
			<dataGroupName><![CDATA[BS_SIM]]></dataGroupName>
			<ui>
				<position x="477" y="240" />
				<description><![CDATA[]]></description>
			</ui>
			<addColumns>
				<derivedColumn name="UPFLAG"><![CDATA[IIF( (MVSUM(@{MEAN}, 10, 1) - MVSUM(@{MEAN}, 5, 1)) / 5 <= MVAVG(@{MEAN}, 5, 1), 1, 0 )]]></derivedColumn>
				<derivedColumn name="T_RETAIN"><![CDATA[CASE( 0
  , @ROWNUM < $(N) + 1, 0
  , GETVALUE(@THIS, -1) < 0, 0
  , GETVALUE(@THIS, -1) > 0 AND GETVALUE(@THIS, -1) * (1 + $(RP)) <= {MEAN}, -1
  , GETVALUE(@THIS, -1) > 0 AND ISBETWEEN(GETVALUE(@THIS, -1) * (1 - $(RL)), {LP}, {HP}), -2
  , GETVALUE(@THIS, -1) > 0, GETVALUE(@THIS, -1)
  , {ELEM_IDX} > $(B) AND {UPFLAG} > 0 AND ISBETWEEN({GUESS_BP}[-1], {LP}, {HP}), {GUESS_BP}[-1]
)]]></derivedColumn>
				<derivedColumn name="DAYS"><![CDATA[IIF( {T_RETAIN} <> 0, GETVALUE(@THIS, -1) + 1, 0 )]]></derivedColumn>
				<derivedColumn name="RETAIN"><![CDATA[IIF( {DAYS}[-1] = 15 AND {T_RETAIN} > 0, -3,
  IIF( {DAYS}[-1] > 15, 0, {T_RETAIN} )
)]]></derivedColumn>
				<derivedColumn name="PL"><![CDATA[CASE( 0
  , @ROWNUM < $(N) + 1, 0
  , {RETAIN} = -1, {MEAN} - {RETAIN}[-1]
  , {RETAIN} = -2, {MEAN} - {RETAIN}[-1]
  , {RETAIN} = -3, {MEAN} - {RETAIN}[-1]
)]]></derivedColumn>
			</addColumns>
		</processingElem>

		<processingElem type="groupingValue">
			<dataSource alias="A1"><![CDATA[BS_SIM]]></dataSource>
			<dataGroupName><![CDATA[PROFIT_SUM]]></dataGroupName>
			<ui>
				<position x="655" y="176" />
				<description><![CDATA[]]></description>
			</ui>
			<groupingColumns><![CDATA[PCODE]]></groupingColumns>
			<generate>
				<column type="sum" delimiter=";" toName="PROFIT"><![CDATA[PL]]></column>
			</generate>
		</processingElem>

		<processingElem type="merge">
			<dataSources>
				<dataSource alias="A1"><![CDATA[INDEX_DATA]]></dataSource>
				<dataSource alias="A2"><![CDATA[STD_BASIS]]></dataSource>
			</dataSources>
			<dataGroupName><![CDATA[ANAL_DATA]]></dataGroupName>
			<ui>
				<position x="205" y="233" />
				<description><![CDATA[]]></description>
			</ui>
			<joinMethod>inner</joinMethod>
			<addKeyColumn>false</addKeyColumn>
			<joinKeys>
				<joinKey source="INDEX_DATA"><![CDATA[PCODE]]></joinKey>
				<joinKey source="STD_BASIS"><![CDATA[PCODE]]></joinKey>
			</joinKeys>
			<selectColumns>
				<columns source="INDEX_DATA"><![CDATA[*]]></columns>
				<columns source="STD_BASIS"><![CDATA[SV5MEAN,SV5STD]]></columns>
			</selectColumns>
			<!-- add rename element to rename selected column(s)
			<renameMap><rename source="dataSrouce" column="columnName to be changed">new name</rename> ... </renameMap>
			-->
		</processingElem>

		<processingElem type="sort">
			<dataSource alias="A1"><![CDATA[ANAL_DATA]]></dataSource>
			<dataGroupName><![CDATA[SRT_DATA]]></dataGroupName>
			<ui>
				<position x="330" y="233" />
				<description><![CDATA[]]></description>
			</ui>
			<sortColumns>
				<column order="ascending">날짜</column>
			</sortColumns>
		</processingElem>
	</dataProcessing>

	<dataLoadings>
		<dataLoading name="SAVE_STAT" source="PROFIT_SUM" type="file">
			<filePath><![CDATA[$(OUT_PATH)stat-$(PCODE).txt]]></filePath>
			<remainFinFile><![CDATA[false]]></remainFinFile>
			<finFile><![CDATA[]]></finFile>
			<ui>
				<position x="796" y="176" />
				<description><![CDATA[]]></description>
			</ui>
		</dataLoading>

		<dataLoading name="SAVE_RETAIN" source="BS_SIM" type="file">
			<filePath><![CDATA[$(OUT_PATH)retain-$(PCODE).txt]]></filePath>
			<remainFinFile><![CDATA[false]]></remainFinFile>
			<finFile><![CDATA[]]></finFile>
			<ui>
				<position x="784" y="349" />
				<description><![CDATA[]]></description>
			</ui>
		</dataLoading>

	</dataLoadings>
</crawlegoProject>
